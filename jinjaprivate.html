<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
  textarea {
    width: 99%;
    height: 25vh;
    display: block;
  }
</style>
<script src="https://cdn.jsdelivr.net/pyodide/v0.28.1/full/pyodide.js"></script>
</head>
<body>
<div>
<div>Jinja template:</div>
<textarea id="template"></textarea>
</div>
<div>
<div>Data (JSON or YAML):<div>
<textarea id="data"></textarea>
</div>
<div>
<button id="formatBtn" onclick="format()" disabled>Wait</button>
</div>
<hr />
<div>
<div>Output:</div>
<textarea id="output" readonly></textarea>
</div>

<script type="text/javascript">
  let formatJinja = () => {};
  const format = () => {
    const template = document.getElementById("template").value;
    const data = document.getElementById("data").value;
    document.getElementById("output").value = formatJinja(template,data);
  };
  async function init() {
    document.getElementById("formatBtn").innerText = "Wait";
    document.getElementById("formatBtn").disabled = true;
    const pyodide = await loadPyodide();
    await pyodide.loadPackage("jinja2");
    await pyodide.loadPackage("pyyaml");
    await pyodide.loadPackage("micropip");
    await pyodide.pyimport("micropip").install("jinja2_ansible_filters");
    formatJinja = pyodide.runPython(`
        from jinja2 import Environment
        from jinja2.exceptions import TemplateSyntaxError as jx_TemplateSyntaxError
        from jinja2_ansible_filters import AnsibleCoreFiltersExtension
        from yaml import load
        from yaml.scanner import ScannerError as yx_ScannerError
        try:
          from yaml import CLoader as Loader
        except ImportError:
          from yaml import Loader

        def format_jinja(template, data):
          try:
            parseddata = load(data, Loader=Loader);
          except Exception as e:
            return "Couldn't parse data:\\n" + str(e)
          if (parseddata is None):
            parseddata = []
          try:
            env = Environment(trim_blocks=True, lstrip_blocks=False, extensions=[AnsibleCoreFiltersExtension])
            env.tests["contains"] = lambda c, i: i in c # Not in AnsibleCoreFiltersExtension
            env.filters["split"] = lambda i, d=None: i.split(d)
            return env.from_string(template).render(parseddata)
          except jx_TemplateSyntaxError as e:
            return "Jinja Syntax Error:\\n" + str(e)
          except yx_ScannerError as e:
            return "YAML Scanner Error:\\n" + str(e)
          except Exception as e:
            return "Unknown Error:\\n" + str(e)

        format_jinja
      `);
    document.getElementById("formatBtn").innerText = "Format";
    document.getElementById("formatBtn").disabled = false;
  }
  init();
</script>

</body>
